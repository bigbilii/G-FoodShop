<html lang="en">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>GFoodShop官方</title>
<meta name="keywords" content="GFoodShop官方订餐外卖网站">
<meta name="description" content="GFoodShop官方订餐外卖网站">


<link href="../bower_components/bootstrap/dist/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="../dist/css/common.css"/>
<link rel="stylesheet" href="../dist/css/main.css"/>
<link rel="stylesheet" href="../dist/css/booking.css"/>
<link rel="stylesheet" href="../dist/css/index.css"/>
<style>
    .amap-sug-result {
        z-index: 9999;
    }
</style>

<body class="" avalonctrl="root">
<div id="rootLoading" class="loading-wrap" style="display: none;">
    <div class="loading-icon"></div>
</div>
<div class="grid-box">
    <!-- header部分 start -->
    <div id="header" avalonctrl="header">
        <div class="base-wrap">
            <div class="header-1-lang clearfix">
            </div>
            <div class="header-2-logo clearfix">
                <div class="box-logo f-l relative">
                    <a class="brand-skip">
                        <img class="barand-logo"
                             src="http://51wm-pic1.oss-cn-hangzhou.aliyuncs.com/null9a9036af-3044-46c9-b33d-1337e5d1d24f.png">
                    </a>
                    <a href="./home.html" class="wm-skip">首页</a>
                </div>
                <div class="box-nav f-r">
                    <div class="user-login-before" style="display: block">
                        <a class="bold" href="./login.html">登录</a>
                        <a class="bold" href="./register.html">注册</a>
                    </div>
                    <div class="user-login" style="display: none">
                        <a class="bold">Hi!!&nbsp;&nbsp;&nbsp;<span id="username"></span></a>
                        <ul class="overlist">
                            <li><a href="./userCenter.html">个人中心</a></li>
                            <li><a href="/user/logout;">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- header部分 end -->

    <!-- main start -->
    <div id="main">
        <div id="mainLoading" class="loading-wrap" style="display: none;">
            <div class="loading-icon"></div>
        </div>
        <!--ms-view:main-->
        <div ui-view="main" data-current-cache="false">
            <div class="base-wrap order-wrap clearfix" avalonctrl="order-view">
                <div class="order-box_l f-l order-box_l-1">
                    <div class="takeout-orders relative">
                        <div class="orders-box">
                            <div class="title">
                                <h3 class="f-l">餐&nbsp;&nbsp;&nbsp;品&nbsp;&nbsp;&nbsp;信&nbsp;&nbsp;&nbsp;息</h3>
                            </div>
                            <ul class="orders-tab">
                                <li class="canpinList-title" style="width: 365px;">餐品</li>
                                <li style="width: 192px;">金额</li>
                                <li style="width: 100px;">份数</li>
                            </ul>
                            <div class="order-list clearfix">
                                <div id="cartMenu">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 点餐单 end -->
                    <!-- 各项费用 -->
                    <div class="fees-box clearfix">
                        <p>
                            <span style="margin-left: 386px;">小计：</span>
                            <em id="totalPrice">¥0</em>
                        </p>
                        <p>
                            <span>餐盒费</span>
                            <em>¥2.0</em>
                        </p>
                        <p>
                            <span>外送费 : </span>
                            <em>¥8</em>
                        </p>
                    </div>

                </div>
                <div class="order-box_r f-r">
                    <!-- 送餐信息 - start -->
                    <div class="deliver-info-box">
                        <h3 class="title-h">送餐地址</h3>
                        <div class="address-located">
                            <span class="addNewAddr-span f-r" data-toggle="modal" data-target="#addAddress">+新增地址</span>
                        </div>
                    </div>
                    <div class="address-list-box" id="addrBox">
                    </div>
                    <div class="pay-type_box other-info-box clearfix">
                        <span class="title f-l">支付方式:</span>
                        <div class="f-l">
                            <div class="pay-type_btn">
                                <a class="a-btn active" href="javascript:void(0);">货到付款</a>
                            </div>
                        </div>
                    </div>
                    <div class="invoice_box other-info-box clearfix">
                        <span class="title f-l">餐具数量:</span>
                        <div class="f-l">
                            <div class="jiaobanbisa_standard">
                                <img src="../dist/images/booking/small-cart-minus.png" onclick="removeTableWare()">
                                <span class="product-num" id="tablewareNum">0</span>
                                <img src="../dist/images/booking/small-cart-plus.png" onclick="addTableWare()">
                            </div>
                        </div>
                    </div>

                    <div class="user-note_box other-info-box clearfix">
                        <span class="title f-l">备注信息:</span>
                        <div class="f-l">
                            <textarea maxlength="60" class="user-note_textarea" name="userNote_jiaobanbisa"
                                      id="userNote_jiaobanbisa" data-duplex-event="change"></textarea>
                        </div>
                    </div>
                    <div class="submit-btn_box">
                        <div class="show-price-box1">
                            <span>总额 : </span>
                            <span id="allPrice">¥0</span>
                        </div>
                        <div class="show-btn-box1">
                            <button class="submit-order_btn" onclick="submitOrder()">确认下单</button>
                            <button onclick="location.href='./booking.html'">返回点餐单</button>
                        </div>
                    </div>
                </div>

            </div>


        </div>
    </div>
    <!-- main end -->
</div>
<!-- end start -->
<div id="footer">
    <div class="base-wrap">
        <img src="../dist/images/navbg2.png" alt="">
        <div class="link">
            <a href="./agreement.html">法律声明 </a>
            <a href="./privacyStatement.html">隐私政策 </a>
        </div>
    </div>
</div>
<div class="modal fade" id="addAddress" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"
     data-backdrop="static">
    <div class="modal-dialog modal-address" role="document">
        <div class="modal-content">
            <div class="modal-header notitle" style="border-bottom: 0px">
               <span aria-hidden="true" data-dismiss="modal" aria-label="Close"
                     class="dk-dialog-close-btn">×</span>
            </div>
            <div class="modal-body" style="padding: 0">
                <div data-include-rendered="rendered" data-include-loaded="loaded">
                    <div class="address-wrap">
                        <div class="inputBox">
                            <span class="map-span">姓名 :</span>
                            <input type="text" name="receiverName" data-duplex-event="change" placeholder="请输入您的姓名"
                                   id="receiverName">
                        </div>
                        <div class="inputBox">
                            <span class="map-span">手机 : </span>
                            <input type="text" name="receiverPhone" placeholder="请输入您的手机号码" id="receiverPhone">
                        </div>
                        <div class="inputBox relative">
                            <span class="map-span">地址 :</span>
                            <input type="text" style="width:326px;" placeholder="请输入您的地址" id="receiverAddress">
                        </div>
                        <div class="inputBox">
                            <span class="map-span mr-16">补全地址 :</span>
                            <input type="text" style="width:302px;" name="appendReceiverAddress" placeholder="请补充详细地址"
                                   id="appendReceiverAddress">
                        </div>

                        <div id="addressMap" style="width: 100%;height: 50%;"></div>
                        <div class="inputBox submitBox">
                            <a class="btn btn-51wm-1" href="javascript:void(0);" onclick="saveAddressInfo()">保存</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end end -->
</body>
<script src="https://webapi.amap.com/maps?v=1.4.14&key=	9440df7c20021787f82fee47fcae58c2&plugin=AMap.Autocomplete,AMap.PlaceSearch"></script>
<script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
<!-- jQuery 3 -->
<script src="../bower_components/jquery/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../bower_components/bootstrap/dist/bootstrap.min.js"></script>
<script src="../dist/js/public.js"></script>
<script src="../dist/js/home.js"></script>

<script>
    var order = {
        productOrders: new Array(),
        address: null,
        tablewareNum: 0,
        description: "",
        boxPrice: 2,
        deliveryPrice: 8,
        allPrice: 0,
        type: "货到付款"
    };

    var addrs = new Array();
    var map = new AMap.Map('addressMap', {
        resizeEnable: true, //是否监控地图容器尺寸变化
        zoom: 11, //初始化地图层级
    });
    //输入提示
    var autoOptions = {
        input: "receiverAddress"
    };
    var auto = new AMap.Autocomplete(autoOptions);
    var placeSearch = new AMap.PlaceSearch({
        map: map
    });  //构造地点查询类
    AMap.event.addListener(auto, "select", select);//注册监听，当选中某条记录时会触发
    function select(e) {
        placeSearch.setCity(e.poi.adcode);
        placeSearch.search(e.poi.name);  //关键字查询查询
        selectAddress = e.poi;
    }

    $(function () {

        getCart();
        getAddress();

    });

    function getCart() {
        $.ajax({
            type: "GET",
            url: "/" + userInfo.id + "/cart/list",
            contentType: "application/json",
            success: function (result) {
                if (result.code === 200) {
                    order.productOrders = result.data.products;
                    flashCart();
                } else {
                    if (isEmptyResult(result)) {
                        alert("未知错误");
                    } else {
                        alert(result.message);
                    }
                }
            },
            error: function (result) {
                var resultMsg = result.responseJSON;
                if (isEmptyResult(resultMsg)) {
                    alert("未知错误");
                } else {
                    alert(resultMsg.message);
                }
            }
        });
    }

    function getAddress() {
        var url = "/" + userInfo.id + "/address/select";
        $.ajax({
            type: "GET",
            url: url,
            contentType: "application/json",
            success: function (result) {
                if (result.code === 200) {
                    addrs = result.data;
                    listAddressDOM();
                } else {
                    if (isEmptyResult(result)) {
                        alert("发生未知错误");
                    } else {
                        alert(result.message);
                    }
                }
            },
            error: function (result) {
                var resultMsg = result.responseJSON;
                if (isEmptyResult(resultMsg)) {
                    alert("发生未知错误");
                } else {
                    alert(resultMsg.message);
                }
            }
        })
    }

    function listAddressDOM() {
        $("#addrBox").empty();
        var data = addrs;
        for (var i = 0; i < data.length; i++) {
            $("#addrBox").append("<dl class=\"address-user_dl\" onclick='selectAddr(this," + i + ")'>" +
                "<dt class=\"address_name\">" + data[i].receiverName + "</dt>" +
                "<dd class=\"address_phone\">" + data[i].receiverPhone + "</dd>" +
                "<dd class=\"address_txt\">" + data[i].receiverAddress + data[i].appendReceiverAddress + "</dd>" +
                "</dl>")
        }
    }

    function removeTableWare() {
        var num = $("#tablewareNum").text();
        if (num > 0) {
            $("#tablewareNum").text(--num);
            order.tablewareNum = num;
        } else {
            $("#tablewareNum").text(0);
            order.tablewareNum = 0;
        }
    }

    function addTableWare() {
        var num = $("#tablewareNum").text();
        if (num >= 10) {
            alert("最多10份餐具");
            return;
        }
        $("#tablewareNum").text(++num);
        order.tablewareNum = num;
    }

    function flashCart() {
        $("#cartMenu").empty();
        var cart = order.productOrders;
        var totalPrice = 0;
        for (var i = 0; i < cart.length; i++) {
            totalPrice += cart[i].price * cart[i].num;
            $("#cartMenu").append("<table class=\"tb-orders-el\" cellpadding=\"0\" cellspacing=\"0\">" +
                "<tbody>" +
                "<tr class=\"normal-con\">" +
                "<td>" +
                "</td>" +
                "<td class=\"canpinList-title-td\" style=\"width: 380px;\">" + cart[i].name +
                "</td>" +
                "<td style=\"width: 80px;\">" + cart[i].price + "</td>" +
                "<td style=\"width: 180px;\">" +
                "<span class=\"current-price border-free\">" + cart[i].num + "</span>" +
                "</td>" +
                "</tr>" +
                "<tr class=\"detail-con\" style=\"display: none;\">" +
                "<td class=\"tb-requirement\" colspan=\"5\">" +
                "</td>" +
                "</tr>" +
                "</tbody>" +
                "</table>")
        }
        $("#totalPrice").text("￥" + totalPrice);
        $("#allPrice").text("￥" + (totalPrice + 10));
        order.allPrice = totalPrice + 10;

    }

    function selectAddr(data, index) {
        if ($(data).hasClass("active")) {
            $(data).removeClass("active");
            order.address = null;
        } else {
            $("#addrBox").find("dl").removeClass("active");
            $(data).addClass("active");
            order.address = addrs[index];
        }
    }

    function saveAddressInfo() {
        var name = $("#receiverName").val().trim();
        var phone = $("#receiverPhone").val().trim();
        var address = $("#receiverAddress").val().trim();
        var appAddress = $("#appendReceiverAddress").val().trim();
        if (isNull(name)) {
            alert("请输入姓名!");
            return;
        }
        if (isNull(phone)) {
            alert("请输入手机号!");
            return;
        }
        if (!validPhone(phone)) {
            alert("请输入正确格式的手机号!");
            return;
        }
        if (isNull(address)) {
            alert("请输入地址!");
            return;
        }
        if (isNull(appAddress)) {
            alert("请输入详细地址!");
            return;
        }
        var data = {"receiverName": name};
        data.receiverPhone = phone;
        data.receiverAddress = address;
        data.appendReceiverAddress = appAddress;
        data.longitude = selectAddress.location.lng;
        data.latitude = selectAddress.location.lat;
        data.cityName = selectAddress.district;
        var url = "/" + userInfo.id + "/address/insert";
        console.log(data);

        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (result) {
                if (result.code === 200) {
                    $("#addAddress").modal('hide');
                    getAddress();
                } else {
                    if (isEmptyResult(result)) {
                        alert("发生未知错误");
                    } else {
                        alert(result.message);
                    }
                }
            },
            error: function (result) {
                var resultMsg = result.responseJSON;
                if (isEmptyResult(resultMsg)) {
                    alert("发生未知错误");
                } else {
                    alert(resultMsg.message);
                }
            }
        })
    }

    $('#addAddress').on('hidden.bs.modal', function (e) {
        $("#receiverName").val("");
        $("#receiverPhone").val("");
        $("#receiverAddress").val("");
        $("#appendReceiverAddress").val("");
    });

    function submitOrder() {
        order.description = $("#userNote_jiaobanbisa").val();
        if (order.address == null) {
            alert("请选择送餐地址");
            return;
        }
        for (var i = 0; i < order.productOrders.length; i++) {
            delete order.productOrders[i]["cart"];
        }
        var url = "/" + userInfo.id + "/order/insert";
        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json",
            data: JSON.stringify(order),
            success: function (result) {
                if (result.code === 200) {
                    alert("成功下单，等待餐厅处理，在个人订单中查看");
                    $(location).prop('href', './home.html');
                } else {
                    if (isEmptyResult(result)) {
                        alert("发生未知错误");
                    } else {
                        alert(result.message);
                    }
                }
            },
            error: function (result) {
                var resultMsg = result.responseJSON;
                if (isEmptyResult(resultMsg)) {
                    alert("发生未知错误");
                } else {
                    alert(resultMsg.message);
                }
            }
        })
    }
</script>

</html>
